### Extract and import maps of CS:GO

Basic steps are in [Import CS:GO Maps](https://www.youtube.com/watch?v=pX2ddaJzFHw&ab_channel=ItsJustChris)


**1. Preparation**
   - Extract a map using tool [bspsrc](https://github.com/ata4/bspsrc/releases)
   - Delete all stuff from scene Blender created at start
   - Open Blender Windows Console (not necessary but importing process can be monitored)
     * `Window->Toggle System Console`

**2. Import**
   - Open Blender and go to `File->Import->Valve Map Format (.vmf)`
   - Select an extracted map (e.g., `de_mirage_d.vmf`)
   - In the right bar (configuration) change the following parameters:
     * Sets `Sky resolution` to 1024
     * Sets `Scale` to 0.01 or something similar, but it's better to choose multiples of 10 
       (I've chosen 0.02 and ended with speed should be multiplied by 2)
     * Save these parameters as preset (simpler in future) to import another map
   - Wait until the selected map is imported

**3. Blender postprocess**
   - Select shading mode viewport in the right upper corner (it's necessary to load texture of the map)
   - Select "SkyBoxes": elements of the map that are located away from it
   - Goto `Object->Transform VMF 3D Sky` (Object placed under Help/Pipeline menus)
   - Also remove warmup scenes (if needed)
   - Save the result as Blender file in some directory (e.g., `de_mirage.blend`)
   - After that (!!!) extract texture from the map:
     * Select all objects on scene
     * Goto `File->External Data->Unpack Resources`
     * Select `Write files to current directory` (this won't work if *.blend wasn't saved before)
     * *Also note that some texture may be not correctly extracted and `VTFEdit` required to get it

   - `Save as` *.blend file and in save menu open preference pane (gear in the right upper corner) check `Compress`.
     **This will remove all textures from blend file (textures now stored in the directory near blend file) 
       and compress it, that significantly decrease size**

   - Export the map as FBX into the same directory where *.blend have been saved (all configurations are defaults). 
     **Don't change `Scale` here (!!!) because it was taken into account during VMF import**
   - In the import menu, change the next configurations:
     * `Hierarchy Type` change to `Create Level Actors`
     * Check `Create Content Folder Hierarchy`
     * Remove skeletal meshes (if its not needed)

**4. Import into UE4 and postprocess**
- Create level in UE4 and import this FBX into it using `File->Import Into Level`
- Fix collisions using Python script [CleanupMap.py](../../Content/Python/CleanupMap.py)
  * By default, all collisions generated by UE4 during import are f**ked up 
    (looks like due to the other CS:GO vertex traversal sequence). Script convert all collisions to complex
    and remove geometry with completely unsupported collisions.
- Fix lightning of the map
  * Remove `light_environment` actor and add default `direct light` and `sky blueprint`
  * All lights are `Static` other than `Stationary`, so if shadows and good lightning
    needed then all `light_*` actors required to be fixed

*Need to be added to Python script!*

**5. Fix opacity of materials with textures with Alpha-layer**
- `Blend mode` should be set to `Translucent` in material node
- Alpha channel of texture should be connected to `Opaque pin`
- See also https://docs.unrealengine.com/5.0/en-US/using-transparency-in-unreal-engine-materials/

*Need to be added to Python script!*

**6. Catalog imported map stuff in UE4**